#include "NRF24L01.h"
#define TX_ADR_WIDTH    5  
#define TX_PLOAD_WIDTH  3  
unsigned char RX_ADDRESS[TX_ADR_WIDTH]  = 
{
  0x34,0x43,0x10,0x10,0x01
};
unsigned char rx_buf[TX_PLOAD_WIDTH] = {0};
unsigned char tx_buf[TX_PLOAD_WIDTH] = {0};


//CONFIGURAÇÃO DO RELÓGIO
#include <Wire.h>        
#include <DS3231.h>      
DS3231 rtc;             
RTCDateTime dataehora;  
#define senhaGsm "temp"
#define pinBotaoCall 4
#define numeroCall "LEITURA_TELA" 
bool temSMS = false;
String telefoneSMS;
String dataHoraSMS;
String mensagemSMS;
String comandoGSM = "";
String ultimoGSM = "";

String AUX_TEMP = "";
String AUX_ANO = "";
String AUX_MES = "";
String AUX_DIA = "";
String AUX_UH = "";
String AUX_UM = "";
String AUX_US = "";

bool callStatus = false;
float temperatura_convertida;
float ultima_temperatura;
float ultima_hora;
float ultimo_minuto;
float ultimo_segundo;
float DIA;
float MES;
float ANO;

float AUX1;
float AUX2;
float AUX3;
float AUX4;
float AUX5;
int contador;
void leGSM();
void enviaSMS(String telefone, String mensagem);
void fazLigacao(String telefone);
void configuraGSM();
void sendDataToNextion();

void setup()
{
    Serial.begin(9600);
    Serial3.begin(9600);
    Serial1.begin(9600); 
    //pino para teste de chamada
    pinMode(pinBotaoCall, INPUT_PULLUP);
    configuraGSM();

    NRF_Init();                        
    NRF_SetRxMode();
    Serial.println("RX.");

    rtc.begin();            //Inicialização do RTC DS3231
    //rtc.setDateTime(__DATE__, __TIME__);   

}

void loop()
{

 Serial.println("########");
    NRF_SetRxMode();
    if(NRF_Receive(rx_buf))
    {
        Serial.print("RX = ");
        contador = 0;
        while ( contador < 3 ) {
        {
         if ( contador < 2){
            Serial.print(rx_buf[contador]);
            Serial.print(",");
         }
            else {
            //temperatura_convertida = ( -40 + (rx_buf[1] / 10) * ( rx_buf[2]/1 + 1 ) );
            AUX1 = -40;
            AUX2 = rx_buf[1]/1;
            AUX3 = 10;
            AUX4 = rx_buf[2]/1;
            AUX5 = 1;
            
            temperatura_convertida = ( AUX1 + ( AUX2 / AUX3 ) * ( AUX4 / AUX5 + AUX5 ) );
            
            Serial.print( temperatura_convertida , 1);
            Serial.print("ºC");

            if (temperatura_convertida >0){
              ultima_temperatura = temperatura_convertida;
            }
            }

            contador = (contador + 1);
        }
        
        
        }
        Serial.println();
        for(int i = 0; i < 3; i++)
            rx_buf[i] = 0;
    }

  dataehora = rtc.getDateTime();     //Atribuindo valores instantâneos de data e hora à instância dataehora
  Serial.print(dataehora.year);     //Imprimindo o Ano  
  ANO =  dataehora.year;
  Serial.print("-");
  Serial.print(dataehora.month);    //Imprimindo o Mês
  MES =  dataehora.month;
  Serial.print("-");
  Serial.print(dataehora.day);      //Imprimindo o Dia
  DIA =  dataehora.day;
  Serial.print(" ");
  Serial.print(dataehora.hour);     //Imprimindo a Hora
 if ( temperatura_convertida > 0 ){
  ultima_hora = dataehora.hour;
 }
  Serial.print(":");
  Serial.print(dataehora.minute);   //Imprimindo o Minuto
   if ( temperatura_convertida > 0 ){
  ultimo_minuto = dataehora.minute;
 }
  Serial.print(":");
  Serial.print(dataehora.second);   //Imprimindo o Segundo
     if ( temperatura_convertida >0 ){
  ultimo_segundo = dataehora.second;
 }
  Serial.println("");
  Serial.println("########");

if ( temperatura_convertida > 0 ){
Connect2Server();       // Establishing connection
Field1(temperatura_convertida);       // Uploading to field 1 of Thingspeak
EndConnection();        // Terminating connection

//Connect2Server();
//Field2(temperatura_convertida);     // Uploading to field 2 of Thingspeak 
//EndConnection(); 
}

sendDataToNextion();
  delay(2000);
 
  leGSM();

  if (comandoGSM != "") {
      Serial.println(comandoGSM);
      ultimoGSM = comandoGSM;
      comandoGSM = "";
  }

  if (temSMS) {
     Serial.println("Chegou Mensagem!!");
     Serial.println();
    
     Serial.print("Remetente: ");  
     Serial.println(telefoneSMS);
     Serial.println();
    
     Serial.print("Data/Hora: ");  
     Serial.println(dataHoraSMS);
     Serial.println();
    
     Serial.println("Mensagem:");  
     Serial.println(mensagemSMS);
     Serial.println();
      
     mensagemSMS.trim();      
     if ( mensagemSMS == senhaGsm ) {
        Serial.println("Enviando SMS de Resposta.");  
         enviaSMS(telefoneSMS, "Temp " + String(ultima_temperatura)+ "___ Coletada "+ String(ultima_hora)+":"+ String(ultimo_minuto)+":"+ String(ultimo_segundo));
         //enviaSMS(telefoneSMS, "ID:__ /T(C):__ /HORA:__ ");
         //enviaSMS(telefoneSMS, String(aux_txt_NODE2)+String(aux_txt_temp)+String(N2_temp)+String(aux_txt_esp)+String(aux_txt_umi)+String(N2_umi)+String(aux_txt_esp)+String(aux_txt_EMPRESA)+String(N2_EMPRESA)+String(aux_txt_NODE3)+String(aux_txt_temp)+String(aux_txt_esp)+String(N3_temp)+String(aux_txt_esp)+String(aux_txt_umi)+String(N3_umi)+String(aux_txt_esp)+String(aux_txt_EMPRESA)+String(N3_EMPRESA));
 
     }
     temSMS = false;
  }

  if (!digitalRead(pinBotaoCall) && !callStatus) {
     Serial.println("Efetuando Ligacao..."); 
     fazLigacao(numeroCall);
     callStatus = true;
  }

  if (ultimoGSM.indexOf("+COLP:") > -1) {
     Serial.println("LIGACAO EM ANDAMENTO");
     ultimoGSM = "";                
  }
       
  if (ultimoGSM.indexOf("NO CARRIER") > -1) {
     Serial.println("LIGACAO TERMINADA");
     ultimoGSM = "";
     callStatus = false;
  }
       
  if (ultimoGSM.indexOf("BUSY") > -1) {
     Serial.println("LINHA/NUMERO OCUPADO");
     ultimoGSM = "";
     callStatus = false;
  }

  if (ultimoGSM.indexOf("NO DIALTONE") > -1) {
     Serial.println("SEM LINHA");
     ultimoGSM = "";
     callStatus = false;
  }
       
  if (ultimoGSM.indexOf("NO ANSWER") > -1) {
     Serial.println("NAO ATENDE");
     ultimoGSM = "";
     callStatus = false;
  }

}

void sendDataToNextion()

{

//TEMPERATURA
           String command_TEMP = "ultima_temp.txt=\"";
           AUX_TEMP = String(ultima_temperatura,1);
           command_TEMP = command_TEMP + AUX_TEMP;
           command_TEMP = command_TEMP + "\"";
         
          Serial1.print(command_TEMP);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);
  
        //ANO
           String command_ANO = "ANO.txt=\"";
           AUX_ANO = String(ANO,0);
           command_ANO = command_ANO + AUX_ANO;
           command_ANO = command_ANO + "\"";
         
          Serial1.print(command_ANO);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);

          //MES
           String command_MES = "MES.txt=\"";
           AUX_MES = String(MES,0);
           command_MES = command_MES + AUX_MES;
           command_MES = command_MES + "\"";
         
          Serial1.print(command_MES);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);


        //DIA
           String command_DIA = "DIA.txt=\"";
           AUX_DIA = String(DIA,0);
           command_DIA = command_DIA + AUX_DIA;
           command_DIA = command_DIA + "\"";
         
          Serial1.print(command_DIA);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);

                //ULTIMA HORA
           String command_UH = "ultima_hora.txt=\"";
           AUX_UH = String(ultima_hora,0);
           command_UH = command_UH + AUX_UH;
           command_UH = command_UH + "\"";
         
          Serial1.print(command_UH);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);

                //ULTIMO MINUTO
           String command_UM = "ultimo_minuto.txt=\"";
           AUX_UM = String(ultimo_minuto,0);
           command_UM = command_UM + AUX_UM;
           command_UM = command_UM + "\"";
         
          Serial1.print(command_UM);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);

                //ULTIMO SEGUNDO
           String command_US = "ultimo_segundo.txt=\"";
           AUX_US = String(ultimo_segundo,0);
           command_US = command_US + AUX_US;
           command_US = command_US + "\"";
         
          Serial1.print(command_US);
          Serial1.write(0xff);
          Serial1.write(0xff);
          Serial1.write(0xff);
}
void leGSM()
{
  static String textoRec = "";
  static unsigned long delay1 = 0;
  static int count=0;  
  static unsigned char buffer[64];

  if (Serial1.available()) {            
 
     while(Serial1.available()) {         
   
        buffer[count++] = Serial1.read();     
        if(count == 64)break;
     }

     textoRec += (char*)buffer;
     delay1   = millis();
     
     for (int i=0; i<count; i++) {
         buffer[i]=NULL;
     } 
     count = 0;                       
  }


  if ( ((millis() - delay1) > 100) && textoRec != "" ) {

     if ( textoRec.substring(2,7) == "+CMT:" ) {
        temSMS = true;
     }

     if (temSMS) {
            
        telefoneSMS = "";
        dataHoraSMS = "";
        mensagemSMS = "";

        byte linha = 0;  
        byte aspas = 0;
        for (int nL=1; nL < textoRec.length(); nL++) {

            if (textoRec.charAt(nL) == '"') {
               aspas++;
               continue;
            }                        
          
            if ( (linha == 1) && (aspas == 1) ) {
               telefoneSMS += textoRec.charAt(nL);
            }

            if ( (linha == 1) && (aspas == 5) ) {
               dataHoraSMS += textoRec.charAt(nL);
            }

            if ( linha == 2 ) {
               mensagemSMS += textoRec.charAt(nL);
            }

            if (textoRec.substring(nL - 1, nL + 1) == "\r\n") {
               linha++;
            }
        }
     } else {
       comandoGSM = textoRec;
     }
     
     textoRec = "";  
  }   


}


void enviaSMS(String telefone, String mensagem) {
  Serial1.print("AT+CMGS=\"" + telefone + "\"\n");
  Serial1.print(mensagem + "\n");
  Serial1.print((char)26); 
}

void fazLigacao(String telefone) {
  Serial1.println("ATH0\n");
  Serial1.print((char)26); 
  Serial1.println("ATD " + telefone + ";\n");
  Serial1.print((char)26); 
}

void configuraGSM() {
   Serial1.print("AT+CMGF=1\n;AT+CNMI=2,2,0,0,0\n;ATX4\n;AT+COLP=1\n"); 
}

void Connect2Server()
{
  Serial3.println("AT");
  delay(200);

  Serial3.println("AT+CPIN?");
  delay(200);

  Serial3.println("AT+CREG?");
  delay(200);

  Serial3.println("AT+CGATT?");
  delay(200);

  Serial3.println("AT+CIPSHUT");
  delay(200);

  Serial3.println("AT+CIPSTATUS");
  delay(200);

  Serial3.println("AT+CIPMUX=0");
  delay(200);

  ShowSerialData();
  //delay(1000);
  Serial3.println("AT+CSTT=\"internet\"");//start task and setting the APN,
  delay(200);

  ShowSerialData();
   delay(200);

  Serial3.println("AT+CIICR");//bring up wireless connection
  delay(200);

  ShowSerialData();
delay(200);

  Serial3.println("AT+CIFSR");//get local IP adress
  delay(200);

  ShowSerialData();
  delay(500);
  Serial3.println("AT+CIPSPRT=0");
  delay(500);

  ShowSerialData();
  delay(500);
  Serial3.println("AT+CIPSTART=\"TCP\",\"api.thingspeak.com\",\"80\"");//start up the connection
  
delay(500);
  ShowSerialData();
delay(500);
  Serial3.println("AT+CIPSEND");//begin send data to remote server
  delay(500);
  ShowSerialData();
    delay(500);
}

void Field1(float data) {
  delay(1000);
  String str = "GET http://api.thingspeak.com/update?api_key=XAV3ZYU8W05VAZQJ&field1=" + String (data,1);
  Serial3.println(str);//begin send data to remote server

    //delay(1000);
  ShowSerialData();
    delay(1000);
  Serial3.println((char)26);//sending
  delay(5000);//waitting for reply, important! the time is base on the condition of internet
  Serial3.println();

  ShowSerialData();

}


void Field2(float data) {
  delay(1000);
  String str = "GET http://api.thingspeak.com/update?api_key=XAV3ZYU8W05VAZQJ&field2=" + String (data,1);
  Serial3.println(str);//begin send data to remote server

  //delay(1000);
  ShowSerialData();
  Serial3.println((char)26);//sending
  delay(5000);//waitting for reply, important! the time is base on the condition of internet
  Serial3.println();

  ShowSerialData();

}

void EndConnection() {
  delay(500);
  Serial3.println("AT+CIPSHUT");//close the connection
  delay(500);
  ShowSerialData();

}

void ShowSerialData()
{
  while(Serial3.available()!=0)
    Serial.write(Serial3.read());
}

